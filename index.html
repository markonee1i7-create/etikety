<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<title>Skladov√Ω syst√©m</title>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 900px;
    margin: auto;
}

.menu {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.menu button {
    flex: 1;
    padding: 12px;
    background: #e8f0ff;
    border: 1px solid #b8c6e0;
    border-radius: 6px;
    font-size: 18px;
    cursor: pointer;
}

input, button, select {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    font-size: 18px;
}

button { cursor: pointer; }

#qr-reader, #label-qr-reader {
    margin-top: 20px;
    display: none;
}

.table-container {
    margin-top: 40px;
    border: 1px solid #ccc;
    padding: 15px;
    border-radius: 10px;
    background: #fafafa;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

table th, table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}

table th {
    background: #e8f0ff;
}
</style>
</head>

<body>

<h2>üì¶ Skladov√Ω syst√©m</h2>

<nav class="menu">
    <button onclick="showSection('vydaj')">V√Ωdaj</button>
    <button onclick="showSection('tlac')">Tlaƒç etikety</button>
    <button onclick="showSection('inventura')">Invent√∫ra</button>
</nav>

<!-- ===========================
     V√ùDAJ
=========================== -->
<div id="section-vydaj">

<h3>üì¶ V√Ωdaj materi√°lu</h3>

<input id="cisloMaterialu" type="text" placeholder="ƒå√≠slo materi√°lu">

<button onclick="startScanner()">üì∑ Skenova≈• QR/EAN</button>
<button onclick="stopScanner()" style="background:#ffe4e4;">‚õî Vypn√∫≈• kameru</button>

<div id="qr-reader"></div>

<input id="datumVydaja" type="text" placeholder="D√°tum v√Ωdaja" disabled>
<input id="nazovDielu" type="text" placeholder="N√°zov dielu (pr√°zdne)" disabled>

<input id="pocet" type="number" min="1" value="1" placeholder="Poƒçet">

<input id="zona" type="text" placeholder="Z√≥na">
<input id="stanica" type="text" placeholder="Stanica">

<input id="ziadatel" type="text" placeholder="≈Ωiadateƒæ (CDSID)">
<input id="vydal" type="text" placeholder="Vydal (CDSID)">

<input id="casVydaja" type="text" placeholder="ƒåas v√Ωdaja" disabled>

<button onclick="ulozVydaj()">üíæ Ulo≈æi≈• v√Ωdaj</button>

<div class="table-container">
    <h3>üìã Z√°znamy o v√Ωdaji</h3>

    <table id="vydajTable">
        <thead>
            <tr>
                <th>ƒå√≠slo materi√°lu</th>
                <th>D√°tum</th>
                <th>ƒåas</th>
                <th>N√°zov dielu</th>
                <th>Poƒçet</th>
                <th>Z√≥na</th>
                <th>Stanica</th>
                <th>≈Ωiadateƒæ</th>
                <th>Vydal</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button onclick="exportExcel()" style="margin-top:20px; background:#b7e4c7;">
        üì§ Export do Excelu / MS Teams
    </button>

    <button onclick="vymazVsetko()" style="margin-top:20px; background:#ffdddd;">
        ‚ùå Vymaza≈• v≈°etky z√°znamy
    </button>
</div>

</div>

<!-- ===========================
     TLAƒå ETIKETY (IBA IP)
=========================== -->
<div id="section-tlac" style="display:none;">
    <h3>üñ®Ô∏è Tlaƒç etikety</h3>

    <input id="etiketaText" type="text" placeholder="ƒå√≠slo pre QR k√≥d">

    <button onclick="startLabelScanner()">üì∑ Skenova≈• QR/EAN</button>
    <button onclick="stopLabelScanner()" style="background:#ffe4e4;">‚õî Vypn√∫≈• kameru</button>

    <div id="label-qr-reader"></div>

    <h4>IP adresa tlaƒçiarne</h4>
    <input id="printerIP" type="text" placeholder="192.168.x.x">

    <button onclick="connectPrinterLAN()">üîå Overi≈• pripojenie</button>
    <p id="printerStatus" style="margin-top:10px; color:#555;"></p>

    <button onclick="printLabel()">üñ®Ô∏è Vytlaƒçi≈• etiketu</button>
</div>

<!-- ===========================
     INVENT√öRA
=========================== -->
<div id="section-inventura" style="display:none;">
    <h3>üìã Invent√∫ra</h3>
    <p>Modul invent√∫ry bude doplnen√Ω.</p>
</div>

<script>
/* ---------------- PREP√çNANIE SEKCI√ç ---------------- */
function showSection(name) {
    document.getElementById("section-vydaj").style.display = "none";
    document.getElementById("section-tlac").style.display = "none";
    document.getElementById("section-inventura").style.display = "none";

    document.getElementById("section-" + name).style.display = "block";

    if (name === "vydaj") {
        const now = new Date();
        document.getElementById("datumVydaja").value = now.toLocaleDateString();
        document.getElementById("casVydaja").value = now.toLocaleTimeString();
    }
}

/* ---------------- QR SKENER (V√ùDAJ) ---------------- */
let qrScanner = null;

function startScanner() {
    const reader = document.getElementById("qr-reader");
    reader.style.display = "block";

    qrScanner = new Html5Qrcode("qr-reader");

    qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        decoded => {
            document.getElementById("cisloMaterialu").value = decoded;
            stopScanner();
        }
    );
}

function stopScanner() {
    const reader = document.getElementById("qr-reader");
    reader.style.display = "none";

    if (qrScanner) {
        qrScanner.stop();
        qrScanner = null;
    }
}

/* ---------------- QR SKENER (TLAƒå) ---------------- */
let labelScanner = null;

function startLabelScanner() {
    const reader = document.getElementById("label-qr-reader");
    reader.style.display = "block";

    labelScanner = new Html5Qrcode("label-qr-reader");

    labelScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        decoded => {
            document.getElementById("etiketaText").value = decoded;
            stopLabelScanner();
        }
    );
}

function stopLabelScanner() {
    const reader = document.getElementById("label-qr-reader");
    reader.style.display = "none";

    if (labelScanner) {
        labelScanner.stop();
        labelScanner = null;
    }
}

/* ---------------- ULO≈ΩENIE V√ùDAJA ---------------- */
function ulozVydaj() {
    const cisloMaterialu = document.getElementById("cisloMaterialu").value.trim();
    const pocet = parseInt(document.getElementById("pocet").value);
    const zona = document.getElementById("zona").value.trim();
    const stanica = document.getElementById("stanica").value.trim();
    const ziadatel = document.getElementById("ziadatel").value.trim();
    const vydal = document.getElementById("vydal").value.trim();

    if (!cisloMaterialu || !pocet || !zona || !stanica || !ziadatel || !vydal) {
        alert("Vypl≈à v≈°etky povinn√© √∫daje");
        return;
    }

    const now = new Date();

    const zaznam = {
        cisloMaterialu: cisloMaterialu,
        datum: now.toLocaleDateString(),
        cas: now.toLocaleTimeString(),
        nazovDielu: "",
        pocet: pocet,
        zona: zona,
        stanica: stanica,
        ziadatel: ziadatel,
        vydal: vydal
    };

    let log = JSON.parse(localStorage.getItem("vydajLog") || "[]");
    log.push(zaznam);
    localStorage.setItem("vydajLog", JSON.stringify(log));

    zobrazTabulku();

    document.getElementById("cisloMaterialu").value = "";
    document.getElementById("pocet").value = 1;
    document.getElementById("zona").value = "";
    document.getElementById("stanica").value = "";
    document.getElementById("ziadatel").value = "";
    document.getElementById("vydal").value = "";
}

/* ---------------- TABUƒΩKA ---------------- */
function zobrazTabulku() {
    const tbody = document.querySelector("#vydajTable tbody");
    tbody.innerHTML = "";

    let log = JSON.parse(localStorage.getItem("vydajLog") || "[]");

    log.forEach(z => {
        const row = `
            <tr>
                <td>${z.cisloMaterialu}</td>
                <td>${z.datum}</td>
                <td>${z.cas}</td>
                <td>${z.nazovDielu}</td>
                <td>${z.pocet}</td>
                <td>${z.zona}</td>
                <td>${z.stanica}</td>
                <td>${z.ziadatel}</td>
                <td>${z.vydal}</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

/* ---------------- VYMAZANIE ---------------- */
function vymazVsetko() {
    if (confirm("Naozaj chce≈° vymaza≈• v≈°etky z√°znamy?")) {
        localStorage.removeItem("vydajLog");
        zobrazTabulku();
    }
}

/* ---------------- EXPORT DO EXCELU + MS TEAMS ---------------- */
function exportExcel() {
    let log = JSON.parse(localStorage.getItem("vydajLog") || "[]");

    if (log.length === 0) {
        alert("≈Ωiadne z√°znamy na export");
        return;
    }

    const worksheet = XLSX.utils.json_to_sheet(log);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Vydaj");

    const excelBuffer = XLSX.write(workbook, { bookType: "xlsx", type: "array" });
    const file = new File([excelBuffer], "vydaj.xlsx", {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    });

    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        navigator.share({
            title: "V√Ωdaj materi√°lu",
            text: "Export v√Ωdaja materi√°lu",
            files: [file]
        });
    } else {
        const blob = new Blob([excelBuffer], {
            type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "vydaj.xlsx";
        a.click();
        URL.revokeObjectURL(url);
    }
}

/* ---------------- LAN PRIPOJENIE ---------------- */
async function connectPrinterLAN() {
    const ip = document.getElementById("printerIP").value.trim();
    if (!ip) {
        alert("Zadaj IP adresu tlaƒçiarne");
        return;
    }

    try {
        await fetch(`http://${ip}:9100`, { method: "POST", body: "" });
        document.getElementById("printerStatus").innerText = "Tlaƒçiare≈à online ‚úî";
    } catch {
        document.getElementById("printerStatus").innerText = "Tlaƒçiare≈à nedostupn√° ‚úñ";
    }
}

/* ---------------- TLAƒå ETIKETY CEZ IP ---------------- */
async function printLabel() {
    const data = document.getElementById("etiketaText").value.trim();
    const ip = document.getElementById("printerIP").value.trim();

    if (!data) {
        alert("Zadaj ƒç√≠slo pre QR k√≥d");
        return;
    }
    if (!ip) {
        alert("Zadaj IP adresu tlaƒçiarne");
        return;
    }

    const zpl = `
^XA
^FO50,50^BQN,2,6^FDLA,${data}^FS
^FO50,300^A0N,60,60^FD${data}^FS
^XZ`;

    await fetch(`http://${ip}:9100`, {
        method: "POST",
        body: zpl
    });

    document.getElementById("printerStatus").innerText = "Etiketa odoslan√° ‚úî";
}
</script>

</body>
</html>

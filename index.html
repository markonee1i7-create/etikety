<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<title>SkladovÃ½ systÃ©m</title>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 800px;
    margin: auto;
}

/* MENU */
.menu {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.menu button {
    flex: 1;
    padding: 12px;
    background: #e8f0ff;
    border: 1px solid #b8c6e0;
    border-radius: 6px;
    font-size: 18px;
    cursor: pointer;
}

/* VÅ EOBECNÃ‰ */
input, button, select {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    font-size: 18px;
}

button { cursor: pointer; }

#qr-reader, #label-qr-reader {
    margin-top: 20px;
    display: none;
}

.table-container {
    margin-top: 40px;
    border: 1px solid #ccc;
    padding: 15px;
    border-radius: 10px;
    background: #fafafa;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

table th, table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}

table th {
    background: #e8f0ff;
}

.filter-box {
    margin-top: 20px;
    display: flex;
    gap: 10px;
}

.filter-box input {
    flex: 1;
}
</style>
</head>

<body>

<h2>ğŸ“¦ SkladovÃ½ systÃ©m</h2>

<!-- NAVIGAÄŒNÃ‰ MENU -->
<nav class="menu">
    <button onclick="showSection('vydaj')">VÃ½daj</button>
    <button onclick="showSection('tlac')">TlaÄ etikety</button>
    <button onclick="showSection('inventura')">InventÃºra</button>
</nav>

<!-- ===========================
     SEKCIa: VÃDAJ
=========================== -->
<div id="section-vydaj">

<h3>ğŸ“¦ VÃ½daj tovaru</h3>

<input id="art" type="text" placeholder="ArtiklovÃ© ÄÃ­slo">

<button onclick="startScanner()">ğŸ“· SkenovaÅ¥ QR/EAN</button>
<button onclick="stopScanner()" style="background:#ffe4e4;">â›” VypnÃºÅ¥ kameru</button>

<div id="qr-reader"></div>

<input id="ziadatel" type="text" placeholder="Å½iadateÄ¾">
<input id="vydal" type="text" placeholder="Vydal">

<input id="pocet" type="number" min="1" value="1" placeholder="PoÄet ks">

<button onclick="ulozVydaj()">ğŸ’¾ UloÅ¾iÅ¥ vÃ½daj</button>

<div class="table-container">
    <h3>ğŸ“‹ ZÃ¡znamy o vÃ½daji</h3>

    <div class="filter-box">
        <input id="filterText" type="text" placeholder="FiltrovaÅ¥ text"
               oninput="zobrazTabulku()">
        <input id="filterDate" type="date" oninput="zobrazTabulku()">
    </div>

    <!-- NOVÃ FILTER ZMENY -->
    <select id="filterShift" onchange="zobrazTabulku()">
        <option value="all">VÅ¡etko</option>
        <option value="ranna">RannÃ¡ zmena (06:00â€“18:00)</option>
        <option value="nocna">NoÄnÃ¡ zmena (18:00â€“06:00)</option>
    </select>

    <table id="vydajTable">
        <thead>
            <tr>
                <th>DÃ¡tum</th>
                <th>ÄŒas</th>
                <th>Artikl</th>
                <th>PoÄet</th>
                <th>Å½iadateÄ¾</th>
                <th>Vydal</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button onclick="shareExcel()" style="margin-top:20px; background:#b7e4c7;">
        ğŸ“¤ ZdieÄ¾aÅ¥ Excel
    </button>

    <button onclick="vymazVsetko()" style="margin-top:20px; background:#ffdddd;">
        âŒ VymazaÅ¥ vÅ¡etky zÃ¡znamy
    </button>
</div>

</div>

<!-- ===========================
     SEKCIa: TLAÄŒ ETIKETY
=========================== -->
<div id="section-tlac" style="display:none;">
    <h3>ğŸ–¨ï¸ TlaÄ etikety</h3>

    <input id="etiketaText" type="text" placeholder="ÄŒÃ­slo pre QR kÃ³d">

    <button onclick="startLabelScanner()">ğŸ“· SkenovaÅ¥ QR/EAN</button>
    <button onclick="stopLabelScanner()" style="background:#ffe4e4;">â›” VypnÃºÅ¥ kameru</button>

    <div id="label-qr-reader"></div>

    <h4>Pripojenie tlaÄiarne</h4>

    <select id="printerMode" onchange="switchPrinterMode()">
        <option value="usb">USB (WebUSB)</option>
        <option value="lan">LAN (IP adresa)</option>
    </select>

    <input id="printerIP" type="text" placeholder="IP adresa tlaÄiarne"
           style="display:none;">

    <button onclick="connectPrinter()">ğŸ”Œ PripojiÅ¥ tlaÄiareÅˆ</button>
    <p id="printerStatus" style="margin-top:10px; color:#555;"></p>

    <button onclick="printLabel()">ğŸ–¨ï¸ VytlaÄiÅ¥ etiketu</button>
</div>

<!-- ===========================
     SEKCIa: INVENTÃšRA
=========================== -->
<div id="section-inventura" style="display:none;">
    <h3>ğŸ“‹ InventÃºra</h3>
    <p>Tu mÃ´Å¾e byÅ¥ skener + poÄÃ­tanie + export do Excelu.</p>
</div>

<script>
/* ---------------- MENU PREPÃNANIE ---------------- */
function showSection(name) {
    document.getElementById("section-vydaj").style.display = "none";
    document.getElementById("section-tlac").style.display = "none";
    document.getElementById("section-inventura").style.display = "none";

    document.getElementById("section-" + name).style.display = "block";
}

/* ---------------- QR SKENER (VÃDAJ) ---------------- */
let qrScanner = null;

function startScanner() {
    const reader = document.getElementById("qr-reader");
    reader.style.display = "block";

    qrScanner = new Html5Qrcode("qr-reader");

    qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        decoded => {
            document.getElementById("art").value = decoded;
            stopScanner();
        }
    );
}

function stopScanner() {
    const reader = document.getElementById("qr-reader");
    reader.style.display = "none";

    if (qrScanner) {
        qrScanner.stop();
        qrScanner = null;
    }
}

/* ---------------- QR SKENER (TLAÄŒ ETIKETY) ---------------- */
let labelScanner = null;

function startLabelScanner() {
    const reader = document.getElementById("label-qr-reader");
    reader.style.display = "block";

    labelScanner = new Html5Qrcode("label-qr-reader");

    labelScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        decoded => {
            document.getElementById("etiketaText").value = decoded;
            stopLabelScanner();
        }
    );
}

function stopLabelScanner() {
    const reader = document.getElementById("label-qr-reader");
    reader.style.display = "none";

    if (labelScanner) {
        labelScanner.stop();
        labelScanner = null;
    }
}

/* ---------------- VÃBER USB / LAN ---------------- */
function switchPrinterMode() {
    const mode = document.getElementById("printerMode").value;
    const ipField = document.getElementById("printerIP");

    if (mode === "lan") {
        ipField.style.display = "block";
    } else {
        ipField.style.display = "none";
    }
}

/* ---------------- USB PRIPOJENIE (OPRAVENÃ‰) ---------------- */
let zebraDevice = null;

async function connectPrinterUSB() {
    try {
        zebraDevice = await navigator.usb.requestDevice({
            filters: [{ vendorId: 0x0A5F }]
        });

        await zebraDevice.open();
        await zebraDevice.selectConfiguration(1);

        // NÃ¡jdeme interface s BULK OUT endpointom
        const iface = zebraDevice.configuration.interfaces.find(i =>
            i.alternate.endpoints.some(e => e.direction === "out" && e.type === "bulk")
        );

        if (!iface) {
            document.getElementById("printerStatus").innerText =
                "NenaÅ¡iel sa USB tlaÄovÃ½ interface âœ–";
            return;
        }

        await zebraDevice.claimInterface(iface.interfaceNumber);

        // UloÅ¾Ã­me endpoint pre tlaÄ
        const outEndpoint = iface.alternate.endpoints.find(e => e.direction === "out").endpointNumber;
        zebraDevice._outEndpoint = outEndpoint;

        document.getElementById("printerStatus").innerText =
            "TlaÄiareÅˆ pripojenÃ¡ cez USB âœ”";

    } catch (e) {
        console.error(e);
        document.getElementById("printerStatus").innerText =
            "USB pripojenie zlyhalo âœ–";
    }
}

/* ---------------- LAN PRIPOJENIE (port 9100) ---------------- */
async function connectPrinterLAN() {
    const ip = document.getElementById("printerIP").value.trim();
    if (!ip) {
        alert("Zadaj IP adresu tlaÄiarne");
        return;
    }

    try {
        await fetch(`http://${ip}:9100`, {
            method: "POST",
            body: ""
        });

        document.getElementById("printerStatus").innerText =
            "TlaÄiareÅˆ online âœ”";
    } catch {
        document.getElementById("printerStatus").innerText =
            "TlaÄiareÅˆ nedostupnÃ¡ âœ–";
    }
}

/* ---------------- PREPÃNAÄŒ PRIPOJENIA ---------------- */
function connectPrinter() {
    const mode = document.getElementById("printerMode").value;

    if (mode === "usb") {
        connectPrinterUSB();
    } else {
        connectPrinterLAN();
    }
}

/* ---------------- TLAÄŒ ETIKETY ---------------- */
async function printLabel() {
    const data = document.getElementById("etiketaText").value.trim();
    if (!data) {
        alert("Zadaj ÄÃ­slo pre QR kÃ³d");
        return;
    }

    const zpl = `
^XA
^FO50,50^BQN,2,6^FDLA,${data}^FS
^FO50,300^A0N,60,60^FD${data}^FS
^XZ`;

    const mode = document.getElementById("printerMode").value;

    /* USB */
    if (mode === "usb") {
        if (!zebraDevice) {
            alert("Najprv pripoj USB tlaÄiareÅˆ");
            return;
        }

        const encoder = new TextEncoder();
        const zplBytes = encoder.encode(zpl);

        await zebraDevice.transferOut(zebraDevice._outEndpoint, zplBytes);

        document.getElementById("printerStatus").innerText =
            "Etiketa vytlaÄenÃ¡ cez USB âœ”";
    }

    /* LAN */
    if (mode === "lan") {
        const ip = document.getElementById("printerIP").value.trim();
        if (!ip) {
            alert("Zadaj IP adresu tlaÄiarne");
            return;
        }

        await fetch(`http://${ip}:9100`, {
            method: "POST",
            body: zpl
        });

        document.getElementById("printerStatus").innerText =
            "Etiketa odoslanÃ¡ cez LAN âœ”";
    }
}

/* ---------------- ULOÅ½ENIE VÃDAJA ---------------- */
function ulozVydaj() {
    const art = document.getElementById("art").value.trim();
    const ziadatel = document.getElementById("ziadatel").value.trim();
    const vydal = document.getElementById("vydal").value.trim();
    const pocet = parseInt(document.getElementById("pocet").value);

    if (!art || !ziadatel || !vydal || pocet < 1) {
        alert("VyplÅˆ vÅ¡etky Ãºdaje");
        return;
    }

    const now = new Date();
    const zaznam = {
        datum: now.toLocaleDateString(),
        cas: now.toLocaleTimeString(),
        artikl: art,
        pocet: pocet,
        ziadatel: ziadatel,
        vydal: vydal
    };

    let log = JSON.parse(localStorage.getItem("vydajLog") || "[]");
    log.push(zaznam);
    localStorage.setItem("vydajLog", JSON.stringify(log));

    zobrazTabulku();

    document.getElementById("art").value = "";
    document.getElementById("pocet").value = 1;
}

/* ---------------- TABUÄ½KA + FILTRE ---------------- */
function zobrazTabulku() {
    const tbody = document.querySelector("#vydajTable tbody");
    tbody.innerHTML = "";

    const filterText = document.getElementById("filterText").value.toLowerCase();
    const filterDate = document.getElementById("filterDate").value;
    const filterShift = document.getElementById("filterShift").value;

    let log = JSON.parse(localStorage.getItem("vydajLog") || "[]");

    log.forEach(z => {
        // TEXT FILTER
        if (filterText && !JSON.stringify(z).toLowerCase().includes(filterText)) return;

        // DATE FILTER
        if (filterDate && z.datum !== new Date(filterDate).toLocaleDateString()) return;

        // SHIFT FILTER
        const [h, m, s] = z.cas.split(":").map(Number);
        const time = h + m/60;

        if (filterShift === "ranna" && (time < 6 || time >= 18)) return;
        if (filterShift === "nocna" && !(time >= 18 || time < 6)) return;

        const row = `
            <tr>
                <td>${z.datum}</td>
                <td>${z.cas}</td>
                <td>${z.artikl}</td>
                <td>${z.pocet}</td>
                <td>${z.ziadatel}</td>
                <td>${z.vydal}</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

/* ---------------- EXCEL EXPORT ---------------- */
function shareExcel() {
    let log = JSON.parse(localStorage.getItem("vydajLog") || "[]");

    const filterText = document.getElementById("filterText").value.toLowerCase();
    const filterDate = document.getElementById("filterDate").value;
    const filterShift = document.getElementById("filterShift").value;

    let filtered = log.filter(z => {
        if (filterText && !JSON.stringify(z).toLowerCase().includes(filterText)) return false;
        if (filterDate && z.datum !== new Date(filterDate).toLocaleDateString()) return false;

        const [h, m, s] = z.cas.split(":").map(Number);
        const time = h + m/60;

        if (filterShift === "ranna" && (time < 6 || time >= 18)) return false;
        if (filterShift === "nocna" && !(time >= 18 || time < 6)) return false;

        return true;
    });

    if (filtered.length === 0) {
        alert("Å½iadne zÃ¡znamy na export");
        return;
    }

    const worksheet = XLSX.utils.json_to_sheet(filtered);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Vydaje");

    const excelBuffer = XLSX.write(workbook, { bookType: "xlsx", type: "array" });
    const file = new File([excelBuffer], "vydaje.xlsx", {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    });

    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        navigator.share({
            title: "VÃ½daj tovaru",
            text: "OdfiltrovanÃ© zÃ¡znamy",
            files: [file]
        });
    } else {
        alert("ZdieÄ¾anie nie je podporovanÃ©");
    }
}

/* ---------------- VYMAZANIE ---------------- */
function vymazVsetko() {
    if (confirm("Naozaj chceÅ¡ vymazaÅ¥ vÅ¡etky zÃ¡znamy?")) {
        localStorage.removeItem("vydajLog");
        zobrazTabulku();
    }
}
</script>

</body>
</html>

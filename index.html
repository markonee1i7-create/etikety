<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<title>V√Ωdaj tovaru</title>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 700px;
    margin: auto;
}

input, button, select {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    font-size: 18px;
}

button { cursor: pointer; }

#qr-reader { margin-top: 20px; display: none; }

.table-container {
    margin-top: 40px;
    border: 1px solid #ccc;
    padding: 15px;
    border-radius: 10px;
    background: #fafafa;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

table th, table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}

table th {
    background: #e8f0ff;
}

.filter-box {
    margin-top: 20px;
    display: flex;
    gap: 10px;
}

.filter-box input {
    flex: 1;
}
</style>
</head>

<body>

<h2>üì¶ V√Ωdaj tovaru</h2>

<input id="art" type="text" placeholder="Artiklov√© ƒç√≠slo">

<button onclick="startScanner()">üì∑ Skenova≈• QR/EAN</button>
<button onclick="stopScanner()" style="background:#ffe4e4;">‚õî Vypn√∫≈• kameru</button>

<div id="qr-reader"></div>

<input id="ziadatel" type="text" placeholder="≈Ωiadateƒæ">

<select id="vydal">
    <option value="">-- Vyber meno --</option>
    <option value="rpetrik">rpetrik</option>
    <option value="sbobak">sbobak</option>
    <option value="aolejka">aolejka</option>
    <option value="khalamko">khalamko</option>
</select>

<input id="pocet" type="number" min="1" value="1" placeholder="Poƒçet ks">

<button onclick="ulozVydaj()">üíæ Ulo≈æi≈• v√Ωdaj</button>

<div class="table-container">
    <h3>üìã Z√°znamy o v√Ωdaji</h3>

    <div class="filter-box">
        <input id="filterText" type="text" placeholder="Filtrova≈• text (artikl, ≈æiadateƒæ...)"
               oninput="zobrazTabulku()">
        <input id="filterDate" type="date" oninput="zobrazTabulku()">
    </div>

    <table id="vydajTable">
        <thead>
            <tr>
                <th>D√°tum</th>
                <th>ƒåas</th>
                <th>Artikl</th>
                <th>Poƒçet</th>
                <th>≈Ωiadateƒæ</th>
                <th>Vydal</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button onclick="shareToTeams()" style="margin-top:20px; background:#d9eaff;">
        üì§ Zdieƒæa≈• textovo do Teams
    </button>

    <button onclick="shareTableToTeams()" style="margin-top:10px; background:#cfe8ff;">
        üì§ Zdieƒæa≈• tabuƒæku do Teams
    </button>

    <button onclick="shareExcel()" style="margin-top:10px; background:#b7e4c7;">
        üì§ Zdieƒæa≈• Excel
    </button>

    <button onclick="vymazVsetko()" style="margin-top:20px; background:#ffdddd;">
        ‚ùå Vymaza≈• v≈°etky z√°znamy
    </button>
</div>

<script>
/* ---------------- QR SKENER ---------------- */
let qrScanner = null;

function startScanner() {
    const reader = document.getElementById("qr-reader");
    reader.style.display = "block";

    qrScanner = new Html5Qrcode("qr-reader");

    qrScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        decoded => {
            document.getElementById("art").value = decoded;
            stopScanner();
        }
    );
}

function stopScanner() {
    const reader = document.getElementById("qr-reader");
    reader.style.display = "none";

    if (qrScanner) {
        qrScanner.stop();
        qrScanner = null;
    }
}

/* ---------------- ULO≈ΩENIE V√ùDAJA ---------------- */
function ulozVydaj() {
    const art = document.getElementById("art").value.trim();
    const ziadatel = document.getElementById("ziadatel").value.trim();
    const vydal = document.getElementById("vydal").value.trim();
    const pocet = parseInt(document.getElementById("pocet").value);

    if (!art || !ziadatel || !vydal || pocet < 1) {
        alert("Vypl≈à v≈°etky √∫daje");
        return;
    }

    const now = new Date();
    const zaznam = {
        datum: now.toLocaleDateString(),
        cas: now.toLocaleTimeString(),
        artikl: art,
        pocet: pocet,
        ziadatel: ziadatel,
        vydal: vydal
    };

    let log = JSON.parse(localStorage.getItem("vydajLog") || "[]");
    log.push(zaznam);
    localStorage.setItem("vydajLog", JSON.stringify(log));

    zobrazTabulku();

    document.getElementById("art").value = "";
    document.getElementById("pocet").value = 1;
}

/* ---------------- TABUƒΩKA ---------------- */
function zobrazTabulku() {
    const tbody = document.querySelector("#vydajTable tbody");
    tbody.innerHTML = "";

    const filterText = document.getElementById("filterText").value.toLowerCase();
    const filterDate = document.getElementById("filterDate").value;

    let log = JSON.parse(localStorage.getItem("vydajLog") || "[]");

    log.forEach(z => {
        if (filterText && !JSON.stringify(z).toLowerCase().includes(filterText)) return;
        if (filterDate && z.datum !== new Date(filterDate).toLocaleDateString()) return;

        const row = `
            <tr>
                <td>${z.datum}</td>
                <td>${z.cas}</td>
                <td>${z.artikl}</td>
                <td>${z.pocet}</td>
                <td>${z.ziadatel}</td>
                <td>${z.vydal}</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

/* ---------------- ZDIEƒΩANIE DO TEAMS (TEXT) ---------------- */
function shareToTeams() {
    let log = JSON.parse(localStorage.getItem("vydajLog") || "[]");

    const filterText = document.getElementById("filterText").value.toLowerCase();
    const filterDate = document.getElementById("filterDate").value;

    let filtered = log.filter(z => {
        if (filterText && !JSON.stringify(z).toLowerCase().includes(filterText)) return false;
        if (filterDate && z.datum !== new Date(filterDate).toLocaleDateString()) return false;
        return true;
    });

    if (filtered.length === 0) {
        alert("≈Ωiadne z√°znamy na zdieƒæanie");
        return;
    }

    let message = "üì¶ V√Ωdaj tovaru ‚Äì odfiltrovan√© z√°znamy:\n\n";
    filtered.forEach(z => {
        message += `${z.datum} ${z.cas} | ${z.artikl} | ${z.pocet} ks | ${z.ziadatel} | ${z.vydal}\n`;
    });

    if (navigator.share) {
        navigator.share({
            title: "V√Ωdaj tovaru",
            text: message
        });
        return;
    }

    const encoded = encodeURIComponent(message);
    window.open(`https://teams.microsoft.com/share?text=${encoded}`, "_blank");
}

/* ---------------- ZDIEƒΩANIE DO TEAMS (TABUƒΩKA) ---------------- */
function shareTableToTeams() {
    let log = JSON.parse(localStorage.getItem("vydajLog") || "[]");

    const filterText = document.getElementById("filterText").value.toLowerCase();
    const filterDate = document.getElementById("filterDate").value;

    let filtered = log.filter(z => {
        if (filterText && !JSON.stringify(z).toLowerCase().includes(filterText)) return false;
        if (filterDate && z.datum !== new Date(filterDate).toLocaleDateString()) return false;
        return true;
    });

    if (filtered.length === 0) {
        alert("≈Ωiadne z√°znamy na zdieƒæanie");
        return;
    }

    let table = `
        <table border="1" style="border-collapse:collapse;">
            <tr>
                <th>D√°tum</th>
                <th>ƒåas</th>
                <th>Artikl</th>
                <th>Poƒçet</th>
                <th>≈Ωiadateƒæ</th>
                <th>Vydal</th>
            </tr>
    `;

    filtered.forEach(z => {
        table += `
            <tr>
                <td>${z.datum}</td>
                <td>${z.cas}</td>
                <td>${z.artikl}</td>
                <td>${z.pocet}</td>
                <td>${z.ziadatel}</td>
                <td>${z.vydal}</td>
            </tr>
        `;
    });

    table += "</table>";

    const encoded = encodeURIComponent(table);
    window.open(`https://teams.microsoft.com/share?html=${encoded}`, "_blank");
}

/* ---------------- ZDIEƒΩANIE EXCELU ---------------- */
function shareExcel() {
    let log = JSON.parse(localStorage.getItem("vydajLog") || "[]");

    const filterText = document.getElementById("filterText").value.toLowerCase();
    const filterDate = document.getElementById("filterDate").value;

    let filtered = log.filter(z => {
        if (filterText && !JSON.stringify(z).toLowerCase().includes(filterText)) return false;
        if (filterDate && z.datum !== new Date(filterDate).toLocaleDateString()) return false;
        return true;
    });

    if (filtered.length === 0) {
        alert("≈Ωiadne z√°znamy na export");
        return;
    }

    const worksheet = XLSX.utils.json_to_sheet(filtered);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Vydaje");

    const excelBuffer = XLSX.write(workbook, { bookType: "xlsx", type: "array" });
    const file = new File([excelBuffer], "vydaje.xlsx", {
        type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    });

    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        navigator.share({
            title: "V√Ωdaj tovaru",
            text: "Odfiltrovan√© z√°znamy vo form√°te Excel",
            files: [file]
        });
    } else {
        alert("Toto zariadenie nepodporuje zdieƒæanie Excel s√∫borov");
    }
}

/* ---------------- VYMAZANIE ---------------- */
function vymazVsetko() {
    if (confirm("Naozaj chce≈° vymaza≈• v≈°etky z√°znamy?")) {
        localStorage.removeItem("vydajLog");
        zobrazTabulku();
    }
}

window.onload = zobrazTabulku;
</script>

</body>
</html>

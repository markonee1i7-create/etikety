<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<title>SkladovÃ½ systÃ©m</title>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 900px;
    margin: auto;
}

.menu {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.menu button {
    flex: 1;
    padding: 12px;
    background: #e8f0ff;
    border: 1px solid #b8c6e0;
    border-radius: 6px;
    font-size: 18px;
    cursor: pointer;
}

input, button, select {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    font-size: 18px;
}

button { cursor: pointer; }

#qr-reader, #label-qr-reader, #inv-qr-reader {
    margin-top: 20px;
    display: none;
}

.table-container {
    margin-top: 40px;
    border: 1px solid #ccc;
    padding: 15px;
    border-radius: 10px;
    background: #fafafa;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

table th, table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}

table th {
    background: #e8f0ff;
}
</style>
</head>

<body>

<h2>ğŸ“¦ SkladovÃ½ systÃ©m</h2>

<nav class="menu">
    <button onclick="showSection('vydaj')">VÃ½daj</button>
    <button onclick="showSection('tlac')">TlaÄ etikety</button>
    <button onclick="showSection('inventura')">InventÃºra</button>
</nav>

<!-- ===========================
     VÃDAJ
=========================== -->
<div id="section-vydaj">

<h3>ğŸ“¦ VÃ½daj materiÃ¡lu</h3>

<input id="cisloMaterialu" type="text" placeholder="ÄŒÃ­slo materiÃ¡lu">

<button onclick="startScanner()">ğŸ“· SkenovaÅ¥ QR/EAN</button>
<button onclick="stopScanner()" style="background:#ffe4e4;">â›” VypnÃºÅ¥ kameru</button>

<div id="qr-reader"></div>

<input id="datumVydaja" type="text" placeholder="DÃ¡tum vÃ½daja" disabled>
<input id="nazovDielu" type="text" placeholder="NÃ¡zov dielu (prÃ¡zdne)" disabled>

<input id="pocet" type="number" min="1" value="1" placeholder="PoÄet">

<input id="zona" type="text" placeholder="ZÃ³na">
<input id="stanica" type="text" placeholder="Stanica">

<input id="ziadatel" type="text" placeholder="Å½iadateÄ¾ (CDSID)">
<input id="vydal" type="text" placeholder="Vydal (CDSID)">

<input id="casVydaja" type="text" placeholder="ÄŒas vÃ½daja" disabled>

<button onclick="ulozVydaj()">ğŸ’¾ UloÅ¾iÅ¥ vÃ½daj</button>

<div class="table-container">
    <h3>ğŸ“‹ ZÃ¡znamy o vÃ½daji</h3>

    <table id="vydajTable">
        <thead>
            <tr>
                <th>ÄŒÃ­slo materiÃ¡lu</th>
                <th>DÃ¡tum</th>
                <th>ÄŒas</th>
                <th>NÃ¡zov dielu</th>
                <th>PoÄet</th>
                <th>ZÃ³na</th>
                <th>Stanica</th>
                <th>Å½iadateÄ¾</th>
                <th>Vydal</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button onclick="exportExcel()" style="margin-top:20px; background:#b7e4c7;">
        ğŸ“¤ Export do Excelu / MS Teams
    </button>

    <button onclick="vymazVsetko()" style="margin-top:20px; background:#ffdddd;">
        âŒ VymazaÅ¥ vÅ¡etky zÃ¡znamy
    </button>
</div>

</div>

<!-- ===========================
     TLAÄŒ ETIKETY
=========================== -->
<div id="section-tlac" style="display:none;">
    <h3>ğŸ–¨ï¸ TlaÄ etikety</h3>

    <input id="etiketaText" type="text" placeholder="ÄŒÃ­slo pre QR kÃ³d">

    <button onclick="startLabelScanner()">ğŸ“· SkenovaÅ¥ QR/EAN</button>
    <button onclick="stopLabelScanner()" style="background:#ffe4e4;">â›” VypnÃºÅ¥ kameru</button>

    <div id="label-qr-reader"></div>

    <h4>IP adresa tlaÄiarne</h4>
    <input id="printerIP" type="text" placeholder="192.168.x.x">

    <button onclick="connectPrinterLAN()">ğŸ”Œ OveriÅ¥ pripojenie</button>
    <p id="printerStatus" style="margin-top:10px; color:#555;"></p>

    <button onclick="printLabel()">ğŸ–¨ï¸ VytlaÄiÅ¥ etiketu</button>
</div>

<!-- ===========================
     INVENTÃšRA
=========================== -->
<div id="section-inventura" style="display:none;">
    <h3>ğŸ“‹ InventÃºra</h3>

    <input id="invKod" type="text" placeholder="KÃ³d materiÃ¡lu">

    <button onclick="startInvScanner()">ğŸ“· SkenovaÅ¥ QR/EAN</button>
    <button onclick="stopInvScanner()" style="background:#ffe4e4;">â›” VypnÃºÅ¥ kameru</button>

    <div id="inv-qr-reader"></div>

    <input id="invMnozstvo" type="number" min="0" placeholder="SkutoÄnÃ© mnoÅ¾stvo">

    <button onclick="ulozInventuru()">ğŸ’¾ UloÅ¾iÅ¥ inventÃºru</button>

    <div class="table-container">
        <h3>ğŸ“‹ ZÃ¡znamy inventÃºry</h3>

        <table id="invTable">
            <thead>
                <tr>
                    <th>KÃ³d materiÃ¡lu</th>
                    <th>SkutoÄnÃ© mnoÅ¾stvo</th>
                    <th>DÃ¡tum</th>
                    <th>ÄŒas</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button onclick="exportInventura()" style="margin-top:20px; background:#b7e4c7;">
            ğŸ“¤ Export inventÃºry do Excelu / MS Teams
        </button>

        <button onclick="vymazInventuru()" style="margin-top:20px; background:#ffdddd;">
            âŒ VymazaÅ¥ inventÃºru
        </button>
    </div>
</div>

<script>
    /* ---------------- PREPÃNANIE SEKCIÃ ---------------- */
function showSection(name) {
    document.getElementById("section-vydaj").style.display = "none";
    document.getElementById("section-tlac").style.display = "none";
    document.getElementById("section-inventura").style.display = "none";

    document.getElementById("section-" + name).style.display = "block";

    if (name === "vydaj") {
        const now = new Date();
        document.getElementById("datumVydaja").value = now.toLocaleDateString();
        document.getElementById("casVydaja").value = now.toLocaleTimeString();
    }
}

/* ---------------- ULOÅ½ENIE VÃDAJA ---------------- */
function ulozVydaj() {
    const cislo = document.getElementById("cisloMaterialu").value.trim();
    const datum = document.getElementById("datumVydaja").value;
    const cas = document.getElementById("casVydaja").value;
    const nazov = document.getElementById("nazovDielu").value.trim();
    const pocet = document.getElementById("pocet").value;
    const zona = document.getElementById("zona").value.trim();
    const stanica = document.getElementById("stanica").value.trim();
    const ziada = document.getElementById("ziadatel").value.trim();
    const vydal = document.getElementById("vydal").value.trim();

    if (!cislo || !pocet || !zona || !stanica || !ziada || !vydal) {
        alert("VyplÅˆ vÅ¡etky povinnÃ© polia.");
        return;
    }

    const row = { cislo, datum, cas, nazov, pocet, zona, stanica, ziada, vydal };

    let data = JSON.parse(localStorage.getItem("vydajData") || "[]");
    data.push(row);
    localStorage.setItem("vydajData", JSON.stringify(data));

    nacitajVydaj();
}

/* ---------------- NAÄŒÃTANIE TABUÄ½KY VÃDAJA ---------------- */
function nacitajVydaj() {
    const tbody = document.querySelector("#vydajTable tbody");
    tbody.innerHTML = "";

    const data = JSON.parse(localStorage.getItem("vydajData") || "[]");

    data.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${r.cislo}</td>
            <td>${r.datum}</td>
            <td>${r.cas}</td>
            <td>${r.nazov}</td>
            <td>${r.pocet}</td>
            <td>${r.zona}</td>
            <td>${r.stanica}</td>
            <td>${r.ziada}</td>
            <td>${r.vydal}</td>
        `;
        tbody.appendChild(tr);
    });
}

/* ---------------- EXPORT DO EXCELU ---------------- */
function exportExcel() {
    const data = JSON.parse(localStorage.getItem("vydajData") || "[]");
    if (data.length === 0) {
        alert("Nie sÃº Å¾iadne dÃ¡ta na export.");
        return;
    }

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Vydaj");

    XLSX.writeFile(wb, "vydaj.xlsx");
}

/* ---------------- VYMAZANIE VÃDAJA ---------------- */
function vymazVsetko() {
    if (confirm("Naozaj chceÅ¡ vymazaÅ¥ vÅ¡etky zÃ¡znamy?")) {
        localStorage.removeItem("vydajData");
        nacitajVydaj();
    }
}

/* ---------------- INVENTÃšRA ---------------- */
function ulozInventuru() {
    const kod = document.getElementById("invKod").value.trim();
    const mnozstvo = document.getElementById("invMnozstvo").value;

    if (!kod || mnozstvo === "") {
        alert("VyplÅˆ kÃ³d aj mnoÅ¾stvo.");
        return;
    }

    const now = new Date();
    const row = {
        kod,
        mnozstvo,
        datum: now.toLocaleDateString(),
        cas: now.toLocaleTimeString()
    };

    let data = JSON.parse(localStorage.getItem("invData") || "[]");
    data.push(row);
    localStorage.setItem("invData", JSON.stringify(data));

    nacitajInventuru();
}

function nacitajInventuru() {
    const tbody = document.querySelector("#invTable tbody");
    tbody.innerHTML = "";

    const data = JSON.parse(localStorage.getItem("invData") || "[]");

    data.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${r.kod}</td>
            <td>${r.mnozstvo}</td>
            <td>${r.datum}</td>
            <td>${r.cas}</td>
        `;
        tbody.appendChild(tr);
    });
}

function exportInventura() {
    const data = JSON.parse(localStorage.getItem("invData") || "[]");
    if (data.length === 0) {
        alert("Nie sÃº Å¾iadne dÃ¡ta na export.");
        return;
    }

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Inventura");

    XLSX.writeFile(wb, "inventura.xlsx");
}

function vymazInventuru() {
    if (confirm("Naozaj chceÅ¡ vymazaÅ¥ inventÃºru?")) {
        localStorage.removeItem("invData");
        nacitajInventuru();
    }
}

/* ---------------- OPTIMALIZOVANÃ SKENER PRE iPHONE SE ---------------- */
function optimalConfig() {
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

    return {
        fps: isIOS ? 8 : 12,
        qrbox: isIOS ? 340 : 250,
        aspectRatio: 1.0,
        disableFlip: false,
        experimentalFeatures: {
            useBarCodeDetectorIfSupported: true
        }
    };
}

/* ---------------- SKENER â€“ VÃDAJ ---------------- */
let qrScanner = null;

function startScanner() {
    const reader = document.getElementById("qr-reader");
    reader.style.display = "block";

    const config = optimalConfig();
    qrScanner = new Html5Qrcode("qr-reader");

    qrScanner.start(
        { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } },
        config,
        decoded => {
            document.getElementById("cisloMaterialu").value = decoded;
            stopScanner();
        }
    );
}

function stopScanner() {
    const reader = document.getElementById("qr-reader");
    reader.style.display = "none";

    if (qrScanner) {
        setTimeout(() => qrScanner.stop(), 300);
        qrScanner = null;
    }
}

/* ---------------- SKENER â€“ INVENTÃšRA ---------------- */
let invScanner = null;

function startInvScanner() {
    const reader = document.getElementById("inv-qr-reader");
    reader.style.display = "block";

    const config = optimalConfig();
    invScanner = new Html5Qrcode("inv-qr-reader");

    invScanner.start(
        { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } },
        config,
        decoded => {
            document.getElementById("invKod").value = decoded;
            stopInvScanner();
        }
    );
}

function stopInvScanner() {
    const reader = document.getElementById("inv-qr-reader");
    reader.style.display = "none";

    if (invScanner) {
        setTimeout(() => invScanner.stop(), 300);
        invScanner = null;
    }
}

/* ---------------- SKENER â€“ TLAÄŒ ETIKETY ---------------- */
let labelScanner = null;

function startLabelScanner() {
    const reader = document.getElementById("label-qr-reader");
    reader.style.display = "block";

    const config = optimalConfig();
    labelScanner = new Html5Qrcode("label-qr-reader");

    labelScanner.start(
        { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } },
        config,
        decoded => {
            document.getElementById("etiketaText").value = decoded;
            stopLabelScanner();
        }
    );
}

function stopLabelScanner() {
    const reader = document.getElementById("label-qr-reader");
    reader.style.display = "none";

    if (labelScanner) {
        setTimeout(() => labelScanner.stop(), 300);
        labelScanner = null;
    }
        }
    /* ---------------- TLAÄŒ ETIKETY CEZ IP ---------------- */
function connectPrinterLAN() {
    const ip = document.getElementById("printerIP").value.trim();
    const status = document.getElementById("printerStatus");

    if (!ip) {
        status.textContent = "Zadaj IP adresu tlaÄiarne.";
        status.style.color = "red";
        return;
    }

    fetch("http://" + ip, { method: "GET" })
        .then(() => {
            status.textContent = "TlaÄiareÅˆ je dostupnÃ¡.";
            status.style.color = "green";
        })
        .catch(() => {
            status.textContent = "TlaÄiareÅˆ sa nenaÅ¡la.";
            status.style.color = "red";
        });
}

function printLabel() {
    const ip = document.getElementById("printerIP").value.trim();
    const text = document.getElementById("etiketaText").value.trim();

    if (!ip || !text) {
        alert("Zadaj IP aj text pre etiketu.");
        return;
    }

    const zpl = `
^XA
^FO50,50^A0N,40,40^FD${text}^FS
^FO50,120^BQN,2,6^FDLA,${text}^FS
^XZ
`;

    fetch("http://" + ip + "/pstprnt", {
        method: "POST",
        body: zpl
    })
    .then(() => alert("Etiketa odoslanÃ¡ na tlaÄ."))
    .catch(() => alert("Chyba pri odosielanÃ­ na tlaÄiareÅˆ."));
}

/* ---------------- NAÄŒÃTANIE DÃT PRI Å TARTE ---------------- */
window.onload = function() {
    nacitajVydaj();
    nacitajInventuru();
};
</script>

</body>
</html>

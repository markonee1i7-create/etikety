<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Sklad ‚Äì Vydaj & Invent√∫ra (portr√©t + Excel + iPhone SE)</title>
  <meta name="theme-color" content="#0f766e" />
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#0b1215;--card:#0f1720;--muted:#1a2730;--acc:#0ea5a4;--text:#ecf4f6;--sub:#9fb3bd;--danger:#ef4444;
      --fs:clamp(18px,3.8vw,22px);
      --radius:16px; --pad:18px; --gap:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,#071017,#0b141a),#071017;color:var(--text);font-size:var(--fs);}
    .wrap{max-width:980px;margin:0 auto;padding:12px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
    header h1{margin:0;font-weight:800;letter-spacing:.2px;font-size:clamp(20px,4.2vw,28px)}
    header .badge{background:var(--muted);color:var(--sub);padding:6px 12px;border-radius:999px;font-size:0.85em}

    .tabs{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:8px 0}
    .tab{border:2px solid var(--muted);background:var(--card);color:var(--text);padding:14px 16px;border-radius:var(--radius);cursor:pointer;font-weight:800;letter-spacing:.3px}
    .tab[aria-selected="true"]{background:linear-gradient(180deg,#0f2a2e,#0c2025);border-color:#1a5b61;box-shadow:0 0 0 3px rgba(14,165,164,.18) inset}

    .panel{display:none;background:var(--card);border:2px solid var(--muted);border-radius:var(--radius);padding:var(--pad);min-height:calc(100vh - 170px)}
    .panel.active{display:block}

    .label{color:var(--sub);margin-bottom:6px;font-weight:700}

    input[type="text"], input[data-numeric]{
      width:100%;background:#0b1215;color:var(--text);border:2px solid var(--muted);
      border-radius:var(--radius);padding:18px 16px;font-size:1em;outline:none;
    }
    input[type="text"]:focus, input[data-numeric]:focus{border-color:#1e7a80;box-shadow:0 0 0 4px rgba(14,165,164,.18)}

    .row{display:grid;grid-template-columns:1fr;gap:var(--gap)}

    .btn{display:inline-flex;align-items:center;justify-content:center;width:100%;
      background:#123039;border:2px solid #1a3a41;color:var(--text);padding:16px;border-radius:var(--radius);
      cursor:pointer;font-weight:900;letter-spacing:.3px;user-select:none}
    .btn:hover{border-color:#2a575f}
    .btn.acc{background:#0d3b3e;border-color:#166a70}
    .btn.danger{background:#391b1b;border-color:#6a2f2f}

    .actions{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);margin-top:var(--gap)}
    .actions input[data-numeric]{grid-column:1 / -1}

    .list{margin-top:14px;border-top:2px solid var(--muted);padding-top:10px;max-height:36vh;overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0 10px;font-size:0.95em}
    th,td{padding:16px;background:#0b1215;border:2px solid var(--muted)}
    th{color:var(--sub);background:#0e1820;font-weight:800;position:sticky;top:0;z-index:1}
    tr td:first-child, tr th:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    tr td:last-child, tr th:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}

    .scanner{margin-top:10px;display:none;border:2px dashed #2a3f46;border-radius:var(--radius);padding:8px;position:sticky;top:8px}
    .scanner.active{display:block}

    .rotate-overlay{display:none}
    @media (orientation: landscape){
      .rotate-overlay{display:flex;position:fixed;inset:0;background:rgba(0,0,0,.94);color:#fff;align-items:center;justify-content:center;z-index:9999;text-align:center;padding:24px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Sklad ‚Äì Vydaj & Invent√∫ra</h1>
      <span class="badge">Portr√©t iba ‚Ä¢ iPhone SE optimalizovan√©</span>
    </header>

    <nav class="tabs" role="tablist" aria-label="Sekcie">
      <button class="tab" role="tab" id="tab-issue" aria-controls="panel-issue" aria-selected="true">Vydaj tovaru</button>
      <button class="tab" role="tab" id="tab-inventory" aria-controls="panel-inventory" aria-selected="false">Invent√∫ra</button>
    </nav>

    <!-- Vydaj -->
    <section class="panel active" id="panel-issue" role="tabpanel" aria-labelledby="tab-issue">
      <div class="label">CJL ƒç√≠slo</div>
      <div class="row">
        <input id="issue-cjl" type="text" placeholder="Zadaj alebo naskenuj CJL ƒç√≠slo" autocomplete="off" />
        <button class="btn acc" id="issue-scan">üì∑ Skenova≈• QR</button>
      </div>

      <div class="label">Z√≥na</div>
      <div class="row"><input id="issue-zone" type="text" placeholder="Zadaj z√≥nu" autocomplete="off" /></div>

      <div class="label">Stanica</div>
      <div class="row"><input id="issue-station" type="text" placeholder="Zadaj stanicu" autocomplete="off" /></div>

      <div class="label">≈Ωiadateƒæ CDSID</div>
      <div class="row"><input id="issue-requester" type="text" placeholder="napr. ab1234" autocomplete="off" /></div>

      <div class="label">Vydal CDSID</div>
      <div class="row"><input id="issue-issuer" type="text" placeholder="napr. cd5678" autocomplete="off" /></div>

      <div id="issue-scanner" class="scanner"></div>

      <div class="actions">
        <input id="issue-qty" data-numeric type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Mno≈æstvo (cel√© ƒç√≠slo)" />
        <button class="btn" id="issue-add">‚úÖ Potvr v√Ωdaj</button>
        <button class="btn" id="issue-undo">‚Ü©Ô∏è Undo posledn√©ho v√Ωdaja</button>
        <button class="btn" id="issue-export-xlsx">‚¨áÔ∏è Export Excel (.xlsx)</button>
        <button class="btn" id="issue-share-xlsx">üîó Zdieƒæa≈• do Teams (.xlsx)</button>
        <button class="btn danger" id="issue-clear">üßπ Vyƒçisti≈• polia</button>
      </div>

      <div class="list">
        <table id="issue-table" aria-label="Hist√≥ria v√Ωdajov">
          <thead>
            <tr>
              <th>D√°tum</th>
              <th>ƒåas</th>
              <th>CJL ƒç√≠slo</th>
              <th>Mno≈æstvo</th>
              <th>Z√≥na</th>
              <th>Stanica</th>
              <th>≈Ωiadateƒæ CDSID</th>
              <th>Vydal CDSID</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Invent√∫ra (z√°kladn√°) -->
    <section class="panel" id="panel-inventory" role="tabpanel" aria-labelledby="tab-inventory">
      <div class="label">CJL ƒç√≠slo</div>
      <div class="row">
        <input id="inv-cjl" type="text" placeholder="Zadaj alebo naskenuj CJL ƒç√≠slo" autocomplete="off" />
        <button class="btn acc" id="inv-scan">üì∑ Skenova≈• QR</button>
      </div>
      <div id="inv-scanner" class="scanner"></div>
      <div class="actions">
        <input id="inv-qty" data-numeric type="text" inputmode="numeric" pattern="[0-9]*" placeholder="Poƒçet (cel√© ƒç√≠slo)" />
        <button class="btn" id="inv-add">‚ûï Prida≈• do zoznamu</button>
        <button class="btn" id="inv-export-xlsx">‚¨áÔ∏è Export Excel (.xlsx)</button>
      </div>
      <div class="list">
        <table id="inv-table" aria-label="Hist√≥ria invent√∫r">
          <thead><tr><th>ƒåas</th><th>CJL ƒç√≠slo</th><th>Poƒçet</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <div class="rotate-overlay">Pros√≠m pou≈æ√≠vaj aplik√°ciu <b>v re≈æime na v√Ω≈°ku</b>. Otoƒç zariadenie.</div>

  <script>
    // --- Tabs ---
    const tabs = document.querySelectorAll('.tab');
    const panels = document.querySelectorAll('.panel');
    tabs.forEach(t => t.addEventListener('click', () => {
      tabs.forEach(x => x.setAttribute('aria-selected','false'));
      t.setAttribute('aria-selected','true');
      panels.forEach(p => p.classList.remove('active'));
      document.getElementById(t.getAttribute('aria-controls')).classList.add('active');
      stopScanner();
    }));

    // --- Scanner lifecycle (iPhone SE optimaliz√°cia) ---
    let current = { id:null, instance:null };

    function computeQrbox(viewWidth, viewHeight){
      const size = Math.floor(Math.min(viewWidth, viewHeight) * 0.78);
      const edge = Math.max(200, Math.min(340, size));
      return { width: edge, height: edge };
    }

    async function pickBackCamera(){
      try{
        const devices = await Html5Qrcode.getCameras();
        if(!devices || !devices.length) return null;
        const byLabel = devices.filter(d => /back|rear|environment|zadn/i.test(d.label || ''));
        if(byLabel.length) return byLabel[byLabel.length - 1].id;
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        if(isIOS && devices.length >= 2) return devices[1].id;
        return devices[devices.length - 1].id;
      }catch{ return null; }
    }

    async function startScanner(section){
      if(current.instance) await stopScanner();
      const divId = section + '-scanner';
      const target = document.getElementById(divId);
      target.classList.add('active');

      const html5Qr = new Html5Qrcode(divId);
      current = { id: section, instance: html5Qr };

      const scanConfig = {
        fps: 10,
        qrbox: computeQrbox,
        disableFlip: true,
        aspectRatio: 1.3333
      };

      const onScanSuccess = (decodedText) => {
        const inputId = (section === 'issue') ? 'issue-cjl' : 'inv-cjl';
        document.getElementById(inputId).value = decodedText;
        stopScanner();
      };
      const onScanError = () => {};

      try{
        const backId = await pickBackCamera();
        if(backId){
          await html5Qr.start({ deviceId: { exact: backId } }, scanConfig, onScanSuccess, onScanError);
        }else{
          await html5Qr.start({ facingMode: { exact: 'environment' } }, scanConfig, onScanSuccess, onScanError);
        }
        const video = document.querySelector(`#${divId} video`);
        if(video){
          video.setAttribute('playsinline','true');
          video.setAttribute('webkit-playsinline','true');
          video.setAttribute('autoplay','true');
          video.setAttribute('muted','true');
        }
      }catch(e){
        console.error(e);
        alert('Nepodarilo sa spusti≈• kameru. Sk√∫s Safari cez HTTPS a povoƒæ pr√≠stup ku kamere.');
        stopScanner();
      }
    }

    async function stopScanner(){
      if(current.instance){
        try{ await current.instance.stop(); }catch(e){}
        try{ await current.instance.clear(); }catch(e){}
        const cont = document.getElementById(current.id + '-scanner');
        if(cont) cont.classList.remove('active');
        current = { id:null, instance:null };
      }
    }

    // --- Lok√°lna pam√§≈• (predvoƒæby) ---
    const PREF_KEY = 'issueDefaults';
    function saveDefaults(){
      const data = {
        zone: document.getElementById('issue-zone').value || '',
        station: document.getElementById('issue-station').value || '',
        requester: document.getElementById('issue-requester').value || '',
        issuer: document.getElementById('issue-issuer').value || ''
      };
      try{ localStorage.setItem(PREF_KEY, JSON.stringify(data)); }catch(e){}
    }
    function loadDefaults(){
      try{
        const raw = localStorage.getItem(PREF_KEY);
        if(!raw) return;
        const d = JSON.parse(raw);
        if(d.zone) document.getElementById('issue-zone').value = d.zone;
        if(d.station) document.getElementById('issue-station').value = d.station;
        if(d.requester) document.getElementById('issue-requester').value = d.requester;
        if(d.issuer) document.getElementById('issue-issuer').value = d.issuer;
      }catch(e){}
    }
    ['issue-zone','issue-station','issue-requester','issue-issuer'].forEach(id => {
      document.addEventListener('input', (ev)=>{ if(ev.target && ev.target.id===id) saveDefaults(); });
    });

    // --- Pomocn√© ---
    function addRow(tableId, values){
      const tbody = document.querySelector('#' + tableId + ' tbody');
      const tr = document.createElement('tr');
      values.forEach(v => { const td = document.createElement('td'); td.textContent = v; tr.appendChild(td); });
      tbody.prepend(tr);
    }

    function nowParts(){
      const d = new Date();
      const pad=n=>String(n).padStart(2,'0');
      return {
        date: `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`,
        time: `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`
      };
    }

    function tableToAoA(tableId){
      const rows = Array.from(document.querySelectorAll('#'+tableId+' tr'));
      return rows.map(r => Array.from(r.querySelectorAll('th,td')).map(c => (c.textContent||'')));
    }

    function exportXlsx(tableId, filename){
      try{
        const aoa = tableToAoA(tableId);
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Data');
        XLSX.writeFile(wb, filename);
      }catch(e){
        console.error(e);
        alert('Export do Excelu zlyhal.');
      }
    }

    async function shareXlsx(tableId, filename){
      try{
        const aoa = tableToAoA(tableId);
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Data');
        const ab = XLSX.write(wb, { bookType:'xlsx', type:'array' });
        const file = new File([ab], filename, { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        if(navigator.canShare && navigator.canShare({ files:[file] }) && navigator.share){
          await navigator.share({ files:[file], title:'V√Ωdaj ‚Äì Excel', text:'S√∫bor .xlsx pre Teams/Excel' });
        } else {
          exportXlsx(tableId, filename);
          alert('Zdieƒæanie nie je podporovan√© ‚Äì s√∫bor sa stiahol, prilo≈æ ho do Teams.');
        }
      }catch(e){
        console.error(e);
        exportXlsx(tableId, filename);
      }
    }

    // --- Strict integer input pre Mno≈æstvo ---
    function enforceIntegerInput(el){
      el.addEventListener('input', (e)=>{ e.target.value = e.target.value.replace(/\D+/g,''); });
      el.addEventListener('blur', (e)=>{ if(e.target.value==='' ) e.target.value='0'; });
    }
    enforceIntegerInput(document.getElementById('issue-qty'));
    enforceIntegerInput(document.getElementById('inv-qty'));

    // --- Undo z√°sobn√≠k pre Vydaj ---
    const issueStack = [];

    document.getElementById('issue-clear').addEventListener('click', () => {
      ['issue-cjl','issue-zone','issue-station','issue-requester','issue-issuer','issue-qty'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
      document.getElementById('issue-qty').value='1';
    });

    document.getElementById('issue-add').addEventListener('click', () => {
      const cjl = document.getElementById('issue-cjl').value.trim();
      const zone = document.getElementById('issue-zone').value.trim();
      const station = document.getElementById('issue-station').value.trim();
      const requester = document.getElementById('issue-requester').value.trim();
      const issuer = document.getElementById('issue-issuer').value.trim();
      let qty = document.getElementById('issue-qty').value.trim();
      qty = qty.replace(/\D+/g,'');
      if(qty==='') qty='1';
      if(!cjl){ alert('Zadaj CJL ƒç√≠slo.'); return; }
      const t = nowParts();
      const row = [t.date, t.time, cjl, qty, zone, station, requester, issuer];
      addRow('issue-table', row);
      issueStack.push({ row, restore:{ cjl, zone, station, requester, issuer, qty } });
      document.getElementById('issue-cjl').value='';
      saveDefaults();
    });

    document.getElementById('issue-undo').addEventListener('click', () => {
      const tbody = document.querySelector('#issue-table tbody');
      if(!tbody.firstChild || issueStack.length===0){ alert('Nie je ƒço vr√°ti≈•.'); return; }
      tbody.removeChild(tbody.firstChild);
      const last = issueStack.pop();
      if(last && last.restore){
        document.getElementById('issue-cjl').value = last.restore.cjl;
        document.getElementById('issue-zone').value = last.restore.zone;
        document.getElementById('issue-station').value = last.restore.station;
        document.getElementById('issue-requester').value = last.restore.requester;
        document.getElementById('issue-issuer').value = last.restore.issuer;
        document.getElementById('issue-qty').value = last.restore.qty;
        saveDefaults();
      }
    });

    document.getElementById('issue-export-xlsx').addEventListener('click', () => exportXlsx('issue-table', 'vydaj.xlsx'));
    document.getElementById('issue-share-xlsx').addEventListener('click', () => shareXlsx('issue-table', 'vydaj.xlsx'));

    // Enter = Potvr v√Ωdaj
    document.getElementById('issue-cjl').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ document.getElementById('issue-add').click(); }});

    // --- Akcie Invent√∫ra (light) ---
    document.getElementById('inv-add').addEventListener('click', () => {
      const cjl = document.getElementById('inv-cjl').value.trim();
      let qty = document.getElementById('inv-qty').value.trim();
      qty = qty.replace(/\D+/g,'');
      if(qty==='') qty='0';
      if(!cjl){ alert('Zadaj CJL ƒç√≠slo.'); return; }
      const t = nowParts();
      addRow('inv-table', [`${t.date} ${t.time}`, cjl, qty]);
      document.getElementById('inv-cjl').value='';
    });

    document.getElementById('inv-export-xlsx').addEventListener('click', () => exportXlsx('inv-table', 'inventura.xlsx'));

    // Inicializ√°cia
    loadDefaults();
    if(!document.getElementById('issue-qty').value) document.getElementById('issue-qty').value='1';

    window.addEventListener('beforeunload', stopScanner);
    document.addEventListener('visibilitychange', () => { if(document.hidden) stopScanner(); });
  </script>
</body>
</html>
